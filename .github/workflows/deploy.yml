name: Deploy Prototypes to GitHub Pages

on:
  push:
    branches-ignore:
      - gh-pages
  delete:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: deploy-pages
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ── 1. Determine what triggered the workflow ──
      - name: Set branch info
        id: info
        run: |
          if [ "${{ github.event_name }}" = "delete" ]; then
            # Skip tag deletions — only handle branch deletions
            if [ "${{ github.event.ref_type }}" != "branch" ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Skipping: not a branch deletion"
              exit 0
            fi
            BRANCH_NAME="${{ github.event.ref }}"
            # Skip if the deleted branch is gh-pages
            if [ "$BRANCH_NAME" = "gh-pages" ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Skipping: gh-pages branch"
              exit 0
            fi
            IS_DELETE="true"
          else
            # Push event — extract branch name from ref
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            IS_DELETE="false"
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"
          # Sanitize branch name for use as directory name (replace / with -)
          SAFE_NAME=$(echo "$BRANCH_NAME" | sed 's|/|-|g')
          IS_MAIN="false"
          if [ "$BRANCH_NAME" = "main" ]; then
            IS_MAIN="true"
          fi
          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "safe_name=$SAFE_NAME" >> "$GITHUB_OUTPUT"
          echo "is_main=$IS_MAIN" >> "$GITHUB_OUTPUT"
          echo "is_delete=$IS_DELETE" >> "$GITHUB_OUTPUT"
          echo "Branch: $BRANCH_NAME (safe: $SAFE_NAME) | main=$IS_MAIN | delete=$IS_DELETE"

      # ── 2. Checkout the source branch (skip on delete) ──
      - name: Checkout source branch
        if: steps.info.outputs.skip != 'true' && steps.info.outputs.is_delete == 'false'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.info.outputs.branch }}
          path: source

      # ── 3. Build the Vue app (only for non-main, non-delete) ──
      - name: Setup Node.js
        if: steps.info.outputs.skip != 'true' && steps.info.outputs.is_delete == 'false' && steps.info.outputs.is_main == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      - name: Install dependencies
        if: steps.info.outputs.skip != 'true' && steps.info.outputs.is_delete == 'false' && steps.info.outputs.is_main == 'false'
        working-directory: source
        run: npm ci

      - name: Build prototype
        if: steps.info.outputs.skip != 'true' && steps.info.outputs.is_delete == 'false' && steps.info.outputs.is_main == 'false'
        working-directory: source
        env:
          VITE_BASE_PATH: /prototype/${{ steps.info.outputs.safe_name }}/
        run: npm run build

      # ── 4. Checkout the gh-pages branch ──
      - name: Checkout gh-pages
        if: steps.info.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1

      # ── 5. Update gh-pages content ──
      - name: Remove deleted branch directory
        if: steps.info.outputs.skip != 'true' && steps.info.outputs.is_delete == 'true'
        run: |
          SAFE_NAME="${{ steps.info.outputs.safe_name }}"
          echo "Removing directory for deleted branch: $SAFE_NAME"
          rm -rf "gh-pages/$SAFE_NAME"

      - name: Copy build output to gh-pages
        if: steps.info.outputs.skip != 'true' && steps.info.outputs.is_delete == 'false' && steps.info.outputs.is_main == 'false'
        run: |
          SAFE_NAME="${{ steps.info.outputs.safe_name }}"
          echo "Deploying branch '${{ steps.info.outputs.branch }}' to /$SAFE_NAME/"
          rm -rf "gh-pages/$SAFE_NAME"
          cp -r source/dist "gh-pages/$SAFE_NAME"

      # ── 6. Regenerate the index page ──
      - name: Generate index page
        if: steps.info.outputs.skip != 'true'
        run: |
          # Find all prototype subdirectories (exclude hidden dirs and files)
          PROTOTYPES=""
          for dir in gh-pages/*/; do
            [ -d "$dir" ] || continue
            name=$(basename "$dir")
            # Skip hidden directories
            case "$name" in .*) continue ;; esac
            PROTOTYPES="$PROTOTYPES $name"
          done
          echo "Found prototypes:$PROTOTYPES"

          # Use the generate-index.cjs script from main (or source if available)
          if [ -f "source/scripts/generate-index.cjs" ]; then
            node source/scripts/generate-index.cjs gh-pages/index.html $PROTOTYPES
          else
            # Fallback: fetch script from main
            git clone --depth 1 --branch main \
              https://github.com/${{ github.repository }}.git main-ref 2>/dev/null || true
            if [ -f "main-ref/scripts/generate-index.cjs" ]; then
              node main-ref/scripts/generate-index.cjs gh-pages/index.html $PROTOTYPES
            else
              echo "<html><body><h1>Prototypes</h1><p>No index generator found.</p></body></html>" \
                > gh-pages/index.html
            fi
          fi

      # ── 7. Ensure .nojekyll exists (prevents GitHub from processing with Jekyll) ──
      - name: Add .nojekyll
        if: steps.info.outputs.skip != 'true'
        run: touch gh-pages/.nojekyll

      # ── 8. Commit and push to gh-pages ──
      - name: Deploy to gh-pages
        if: steps.info.outputs.skip != 'true'
        working-directory: gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
          else
            BRANCH="${{ steps.info.outputs.branch }}"
            if [ "${{ steps.info.outputs.is_delete }}" = "true" ]; then
              git commit -m "Remove deployment for deleted branch: $BRANCH"
            elif [ "${{ steps.info.outputs.is_main }}" = "true" ]; then
              git commit -m "Update index page"
            else
              git commit -m "Deploy prototype: $BRANCH"
            fi
            git push
          fi
